& {
	--titlebar-border-radius: 0;
	@media (-moz-platform: macos) {
		--titlebar-border-radius: 10px; //Artificial minimum radii set by macOS's window manager (+the 1px border)
	}
}

// Behaviour: Normal
&:not([menubarvisible]) {
	#tabbrowser-arrowscrollbox {
		padding-top: 14px;
	}
}

// Behaviour: Maximised / Fullscreen
&[sizemode="maximized"],
&[sizemode="fullscreen"] {
	&:not([menubarvisible]) {
		#tabbrowser-arrowscrollbox {
			padding-top: 0;
		}
	}
}

&[gktitnative="false"] {
	//TODO: Fix the theme overlay overlaying fake borders
	
	// Visuals
	&[windowtype="navigator:browser"] > body {
		background: var(--titlebar-active, var(--default-titlebar-active));
		&:-moz-window-inactive {
			background: var(--titlebar-inactive, var(--default-titlebar-inactive));
		}
		border-radius: var(--titlebar-border-radius);
	}
	.titlebar-button {
		color: var(--titlebar-foreground, var(--default-titlebar-foreground)) !important;
	}
	&:-moz-window-inactive {
		.titlebar-button {
			color: var(--titlebar-foreground-inactive, var(--titlebar-foreground-active, var(--default-titlebar-foreground-inactive))) !important;
		}
	}

	// Visuals: Not Windows
	@media not (-moz-platform: windows) {
		//At this stage, the OS has no border, so for accuracy we add a Win10-styled border
		&[windowtype="navigator:browser"] > body {
			border: 1px solid AccentColor;
		}
		&:-moz-window-inactive[windowtype="navigator:browser"] > body {
			border-color: rgb(57,57,57); //Taken from Firefox's browser-aero.css
		}
		&[sizemode="maximized"],
		&[sizemode="fullscreen"] {
			&[windowtype="navigator:browser"] > body {
				border: 0;
			}
		}
	}

	// Visuals: Windows
	@media (-moz-platform: windows) {
		#navigator-toolbox {
			border-top: .5px solid AccentColor;
		}
		&[sizemode="maximized"],
		&[sizemode="fullscreen"] {
			#navigator-toolbox {
				border-top: 0;
			}
		}
	}



























	//TODO: Simplify this and see how much can be shared in _titlebar.scss
	&[lwtheme] {
        /* bruni: This entire code takes care of custom themes support for titlebar */

        &:not([lwtheme-id*="firefox-compact"], [lwtheme-id*="compact-light"]) {

				// Themes with image header/additional images
				&[chromemargin="0,0,0,0"] {
					&[windowtype="navigator:browser"] {
						> body::before {
							content: "";
							position: absolute;
							height: calc(64px + var(--tab-height) + var(--nav-bar-height) + var(--personal-toolbar-height));
							top: 1px;
							left: 1px;
							right: 1px;
							background-color: var(--lwt-accent-color);
							background-image: var(--lwt-additional-images);
							background-repeat: var(--lwt-background-tiling);
							background-position: var(--lwt-background-alignment);
							border-radius: var(--titlebar-border-radius) var(--titlebar-border-radius) 0 0;
						}

						&[sizemode="maximized"],
						&[sizemode="fullscreen"] {
							> body::before {
								border-radius: 0;
								top: 0;
								left: 0;
								right: 0;
							}
						}
					}
				}

				&[style*="--lwt-background-alignment: right center"] {
					&[windowtype="navigator:browser"] > body {
						&::before {
							background-position-y: calc(50% - 9px);
						}
					}
				}

				&[sizemode="maximized"],
				&[sizemode="fullscreen"] {
					&[windowtype="navigator:browser"] > body {
						&::before {
							width: 100%;
							top: -9px;
							left: 0px;
						}
					}
				}

				&[lwtheme-image] {
					&[windowtype="navigator:browser"] > body {
						position: relative;

						&::before {
							background-image: var(--lwt-header-image, linear-gradient(transparent, transparent)), var(--lwt-additional-images) !important;
							background-repeat: no-repeat, var(--lwt-background-tiling);
							background-position: right top, var(--lwt-background-alignment);
							background-position-y: -9px;
							top: 0;
							left: 0;
							right: 0;
							border-radius: var(--titlebar-border-radius) var(--titlebar-border-radius) 0 0;
						}
					}
				}
				
				// Themes without image header/additional images
				&:not([style*="--lwt-additional-images"]) {
					&:not([style*="--lwt-header-image"]) {
						--titlebar-buttonbox-pseudo-background: transparent;

						&:not([privatebrowsingmode="temporary"]),
						&[privatebrowsingmode="temporary"] {
							--titlebar-active: linear-gradient(
								to bottom,
								color-mix(
									in srgb,
									var(--lwt-accent-color) 90%,
									white
								),
								var(--lwt-accent-color) 40px
							) !important;
							--titlebar-inactive: linear-gradient(
								to bottom,
								color-mix(
									in srgb,
									var(--lwt-accent-color) 70%,
									white
								),
								color-mix(
									in srgb,
									var(--lwt-accent-color) 80%,
									white
								)
							) !important;
						}

						&[windowtype="navigator:browser"] > body {
							&::before {
								content: unset;
							}
						}
					}
				}
        }
		
		@media not (-moz-ev-native-controls-patch) {
			background: white !important;
		}
    }
	&[lwtheme-id*="firefox-compact-light"][chrtheme="true"] {
		--titlebar-active: var(--chrt-frame, var(--default-titlebar-active)) !important;
		--titlebar-inactive: var(--chrt-frame-inactive, var(--chrt-frame, var(--default-titlebar-inactive))) !important;

		&[chromemargin="0,0,0,0"] {
			&[windowtype="navigator:browser"] {
				> body {
					&::before {
						content: "";
						position: absolute;
						width: calc(100% - 2px);
						height: 100%;
						background: var(--chrt-theme-frame-overlay) no-repeat, var(--chrt-theme-frame) repeat no-repeat;
						border-radius: var(--titlebar-border-radius) var(--titlebar-border-radius) 0 0;
					}
	
					&:-moz-window-inactive {
						&::before {
							filter: contrast(.5) brightness(1.4);
						}
					}
				}
			}

			&[sizemode="maximized"],
			&[sizemode="fullscreen"] {
				&[windowtype="navigator:browser"] > body {
					&::before {
						width: 100%;
						top: 0px;
						left: 0px;
					}
				}
			}
		}
	}





	//TODO: Determine whether to move this to _titlebar.scss
	//Windows quirks
	@media (-moz-platform: windows) {
		//Stop non-composited titlebar elements from spontaneously appearing
		#titlebar {
			appearance: unset !important;
		}

		//Windows 10 + Native Controls Patch quirks
		@media (-moz-ev-native-controls-patch) {
			&#main-window {
				background: rgba(0,0,0,.002) !important;
			}
		}
	}

	//Linux quirks
	@media (-moz-platform: linux) {
		/* In Linux, we don't have a surface spanning the entire browser window to draw our borders on.
		- GTK3's CSDs only cover the browser from top to bookmarks area
		- Shadows are out of the CSS's boundaries
		Therefore, to get the desired borders, we need to hijack body. */
		#navigator-toolbox-background {
			appearance: none !important; //FIXME: This causes the corner shadows to disappear
		}
	}

	//macOS quirks
	@media (-moz-platform: macos) {
		&[windowtype="navigator:browser"] > body {
			// Corners on the bottom are rounded, as aforementioned, too
			border-radius: var(--titlebar-border-radius);
		}
	}
}